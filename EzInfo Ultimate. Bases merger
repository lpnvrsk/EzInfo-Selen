import sqlite3
import os
import argparse
import glob
import shutil
import sys
from datetime import datetime, timedelta
from pathlib import Path
import re
import time
import logging
from logging.handlers import RotatingFileHandler
from typing import List, Dict, Tuple, Optional, Set
from urllib.parse import quote
import urllib.parse

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================================

# –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã ANSI
class Colors:
    RESET = "\033[0m"
    BOLD = "\033[1m"
    RED = "\033[91m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"
    BLUE = "\033[94m"
    MAGENTA = "\033[95m"
    CYAN = "\033[96m"
    WHITE = "\033[97m"
    GRAY = "\033[90m"
    
    # –§–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞
    BG_RED = "\033[41m"
    BG_GREEN = "\033[42m"
    BG_YELLOW = "\033[43m"
    BG_BLUE = "\033[44m"
    
    # –°—Ç–∏–ª–∏
    UNDERLINE = "\033[4m"
    BLINK = "\033[5m"

# –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
class Emoji:
    INFO = "‚ÑπÔ∏è"
    SUCCESS = "‚úÖ"
    WARNING = "‚ö†Ô∏è"
    ERROR = "‚ùå"
    DATABASE = "üóÑÔ∏è"
    FILE = "üìÅ"
    FOLDER = "üìÇ"
    PLAYER = "üë§"
    GUILD = "üè∞"
    STATS = "üìä"
    CLOCK = "‚è∞"
    SEARCH = "üîç"
    SYNC = "üîÑ"
    COPY = "üìã"
    LOCK = "üîí"
    UNLOCK = "üîì"
    PROCESS = "‚öôÔ∏è"
    SETTINGS = "‚öôÔ∏è"
    LOG = "üìù"
    CALENDAR = "üìÖ"
    HOURGLASS = "‚è≥"
    CHECK = "‚úì"
    CROSS = "‚úó"
    STAR = "‚≠ê"
    FIRE = "üî•"
    ROCKET = "üöÄ"
    TROPHY = "üèÜ"
    COMPUTER = "üíª"
    MAGNIFYING_GLASS = "üîé"
    GEAR = "‚öôÔ∏è"
    WRENCH = "üîß"
    HAMMER = "üî®"
    KEY = "üîë"
    BELL = "üîî"
    FLAG = "üèÅ"
    WAVING_HAND = "üëã"
    TABLE = "üìã"
    GHOST = "üëª"
    SOURCE = "üì•"
    SPEECH = "üí¨"
    KEYBOARD = "‚å®Ô∏è"
    MAN = "üë®"
    WOMAN = "üë©"
    POINT_RIGHT = "üëâ"
    QUESTION = "‚ùì"
    EXIT = "üö™"
    STOP = "üõë"
    BULLET = "‚Ä¢"
    ARROW_RIGHT = "‚û°Ô∏è"
    RETRY = "üîÑ"
    TOGGLE = "üîò"
    SORT = "üîÄ"
    BUG = "üêõ"
    CONFETTI = "üéä"
    PARTY = "üéâ"
    SWORDS = "‚öîÔ∏è"

CONFIG = {
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ tech –±–∞–∑
    'PROCESS_TECH_BASES': True,
    'TECH_TABLE_MIN_RECORDS': 5,
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    'LOG_DIR': "LOGS",
    'LOG_MAX_SIZE_MB': 10,
    'LOG_BACKUP_COUNT': 5,
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
    'SKIP_PATTERNS': ['_temp', '_backup', 'test_'],
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    'HANDLE_DUPLICATE_IDS': True,
    'DUPLICATE_SUFFIX': '_dup',
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SQLite
    'SQLITE_TIMEOUT': 60,  # –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–∞–∑—ã
    'SQLITE_JOURNAL_MODE': 'WAL',  # –†–µ–∂–∏–º –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è (WAL, DELETE, TRUNCATE, PERSIST)
}

# ============================================================================
# –ö–õ–ê–°–° –õ–û–ì–ì–ï–†–ê
# ============================================================================

class Logger:
    """–ö–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª –∏ –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å"""
    def __init__(self):
        self.setup_logging()
        self.reset_stats()
        
    def setup_logging(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
        os.makedirs(CONFIG['LOG_DIR'], exist_ok=True)
        
        log_filename = f"EZInfo_Ultimate_{datetime.now().strftime('%d.%m.%Y_%H%M%S')}.log"
        log_path = os.path.join(CONFIG['LOG_DIR'], log_filename)
        
        self.logger = logging.getLogger('EZInfoLogger')
        self.logger.setLevel(logging.INFO)
        self.logger.handlers = []
        
        formatter = logging.Formatter(
            '%(asctime)s - %(levelname)s - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        file_handler = RotatingFileHandler(
            log_path,
            maxBytes=CONFIG['LOG_MAX_SIZE_MB'] * 1024 * 1024,
            backupCount=CONFIG['LOG_BACKUP_COUNT'],
            encoding='utf-8'
        )
        file_handler.setLevel(logging.INFO)
        file_handler.setFormatter(formatter)
        
        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setLevel(logging.INFO)
        
        # –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ —Å —Ü–≤–µ—Ç–∞–º–∏
        class ColoredFormatter(logging.Formatter):
            def format(self, record):
                levelname = record.levelname
                message = record.getMessage()
                
                if levelname == 'INFO':
                    if '‚úì' in message or '‚úÖ' in message or '—É—Å–ø–µ—à–Ω–æ' in message.lower():
                        return f"{Colors.GREEN}{Emoji.SUCCESS} {message}{Colors.RESET}"
                    elif '–û–±—Ä–∞–±–æ—Ç–∫–∞' in message or '–ù–∞—á–∞–ª–æ' in message:
                        return f"{Colors.CYAN}{Emoji.PROCESS} {message}{Colors.RESET}"
                    elif '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' in message or '—Ä–µ–∑—É–ª—å—Ç–∞—Ç' in message.lower():
                        return f"{Colors.MAGENTA}{Emoji.STATS} {message}{Colors.RESET}"
                    elif '–±–∞–∑' in message.lower() or 'database' in message.lower():
                        return f"{Colors.BLUE}{Emoji.DATABASE} {message}{Colors.RESET}"
                    else:
                        return f"{Colors.GREEN}{Emoji.INFO} {message}{Colors.RESET}"
                elif levelname == 'WARNING':
                    return f"{Colors.YELLOW}{Emoji.WARNING} {message}{Colors.RESET}"
                elif levelname == 'ERROR':
                    return f"{Colors.RED}{Emoji.ERROR} {message}{Colors.RESET}"
                elif levelname == 'DEBUG':
                    return f"{Colors.GRAY}{message}{Colors.RESET}"
                else:
                    return message
        
        console_formatter = ColoredFormatter('%(message)s')
        console_handler.setFormatter(console_formatter)
        
        self.logger.addHandler(file_handler)
        self.logger.addHandler(console_handler)
        
        self.log_path = log_path
        
    def reset_stats(self):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        self.stats = {
            'total_files': 0,
            'processed_files': 0,
            'skipped_files': 0,
            'tech_files': 0,
            'new_players': 0,
            'updated_players': 0,
            'out_players': 0,
            'restored_players': 0,
            'total_players': 0,
            'live_players': 0,
            'active_guilds': 0,
            'duplicate_ids': 0,
            'database_locks': 0,  # –°—á–µ—Ç—á–∏–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ë–î
            'start_time': datetime.now()
        }
        
    def info(self, message, console_only=False):
        if not console_only:
            self.logger.info(message)
        else:
            print(f"{Colors.GREEN}{Emoji.INFO} {message}{Colors.RESET}", end='', flush=True)
    
    def error(self, message):
        self.logger.error(message)
    
    def warning(self, message):
        self.logger.warning(message)
    
    def separator(self, char='‚ïê', length=60):
        separator_line = f"{Colors.CYAN}{char * length}{Colors.RESET}"
        self.logger.info(separator_line)
    
    def header(self, title):
        self.separator()
        header_text = f" {title.upper()} ".center(60, '‚ïê')
        self.logger.info(f"{Colors.CYAN}{Colors.BOLD}{header_text}{Colors.RESET}")
        self.separator()
    
    def subheader(self, title):
        self.separator('-')
        subheader_text = f" {title} "
        self.logger.info(f"{Colors.BLUE}{Colors.BOLD}{subheader_text}{Colors.RESET}")
        self.separator('-')
    
    def update_stats(self, key, value):
        if key in self.stats:
            if key in ['new_players', 'updated_players', 'out_players', 'restored_players', 
                      'processed_files', 'skipped_files', 'tech_files', 'duplicate_ids', 'database_locks']:
                self.stats[key] += value
            else:
                self.stats[key] = value
    
    def log_stats(self):
        """–õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏"""
        self.header(f"{Emoji.STATS} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏ {Emoji.STATS}")
        
        end_time = datetime.now()
        duration = end_time - self.stats['start_time']
        
        self.logger.info(f"{Emoji.CALENDAR} {Colors.BOLD}–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:{Colors.RESET}    {self.stats['start_time'].strftime('%d.%m.%Y %H:%M:%S')}")
        self.logger.info(f"{Emoji.CLOCK} {Colors.BOLD}–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:{Colors.RESET} {end_time.strftime('%d.%m.%Y %H:%M:%S')}")
        self.logger.info(f"{Emoji.HOURGLASS} {Colors.BOLD}–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:{Colors.RESET}    {duration}")
        self.separator('‚îÄ')
        
        self.subheader(f"{Emoji.FILE} –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í:")
        self.logger.info(f"  üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:     {Colors.GREEN}{self.stats['processed_files']}{Colors.RESET}")
        self.logger.info(f"  ‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:      {Colors.YELLOW}{self.stats['skipped_files']}{Colors.RESET}")
        if CONFIG['PROCESS_TECH_BASES']:
            self.logger.info(f"  üîß Tech –±–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:   {Colors.CYAN}{self.stats['tech_files']}{Colors.RESET}")
        self.logger.info(f"  üîÑ –ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ID:  {Colors.YELLOW}{self.stats['duplicate_ids']}{Colors.RESET}")
        self.logger.info(f"  {Emoji.LOCK} –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ë–î:         {Colors.RED}{self.stats['database_locks']}{Colors.RESET}")
        self.separator('‚îÄ')
        
        self.subheader(f"{Emoji.PLAYER} –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –î–ê–ù–ù–´–•:")
        self.logger.info(f"  {Emoji.STAR} –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {Colors.GREEN}{self.stats['new_players']}{Colors.RESET}")
        self.logger.info(f"  üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:       {Colors.BLUE}{self.stats['updated_players']}{Colors.RESET}")
        self.logger.info(f"  ‚ôªÔ∏è  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ out:       {Colors.MAGENTA}{self.stats['restored_players']}{Colors.RESET}")
        self.logger.info(f"  üö´ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ out:           {Colors.YELLOW}{self.stats['out_players']}{Colors.RESET}")
        self.separator('‚îÄ')
        
        self.subheader(f"{Emoji.DATABASE} –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–ó–´:")
        self.logger.info(f"  üìä –í—Å–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:           {Colors.BOLD}{self.stats['total_players']}{Colors.RESET}")
        self.logger.info(f"  {Emoji.FIRE} –ê–∫—Ç–∏–≤–Ω—ã—Ö (live):            {Colors.GREEN}{self.stats['live_players']}{Colors.RESET}")
        if self.stats['total_players'] > 0:
            active_percent = (self.stats['live_players'] / self.stats['total_players']) * 100
            color = Colors.GREEN if active_percent > 70 else Colors.YELLOW if active_percent > 30 else Colors.RED
            self.logger.info(f"  üìà –ü—Ä–æ—Ü–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö:           {color}{active_percent:.1f}%{Colors.RESET}")
        self.separator()
    
    def get_log_path(self):
        return self.log_path


class ProgressBar:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏"""
    def __init__(self, total, prefix='', suffix='', length=50, fill='‚ñà', show_percent=True, show_count=True):
        self.total = total
        self.prefix = prefix
        self.suffix = suffix
        self.length = length
        self.fill = fill
        self.show_percent = show_percent
        self.show_count = show_count
        self.start_time = time.time()
        self.last_update = 0
        
    def update(self, iteration):
        current_time = time.time()
        if current_time - self.last_update < 0.1 and iteration != self.total:
            return
            
        self.last_update = current_time
        percent = 100 * (iteration / float(self.total))
        filled_length = int(self.length * iteration // self.total)
        bar = f"{Colors.GREEN}{self.fill * filled_length}{Colors.RESET}{Colors.GRAY}{'-' * (self.length - filled_length)}{Colors.RESET}"
        
        elapsed_time = current_time - self.start_time
        if iteration > 0:
            time_per_item = elapsed_time / iteration
            remaining_time = time_per_item * (self.total - iteration)
            time_str = f" {Colors.YELLOW}[–æ—Å—Ç–∞–ª–æ—Å—å: {self.format_time(remaining_time)}]{Colors.RESET}"
        else:
            time_str = ""
        
        progress_str = f'\r{self.prefix} {Colors.CYAN}‚îÇ{Colors.RESET}{bar}{Colors.CYAN}‚îÇ{Colors.RESET}'
        if self.show_percent:
            color = Colors.GREEN if percent > 70 else Colors.YELLOW if percent > 30 else Colors.RED
            progress_str += f' {color}{percent:.1f}%{Colors.RESET}'
        if self.show_count:
            progress_str += f' {Colors.GRAY}({iteration}/{self.total}){Colors.RESET}'
        progress_str += f' {self.suffix}{time_str}'
        
        sys.stdout.write(progress_str)
        sys.stdout.flush()
        
        if iteration == self.total:
            print(f"\n{Colors.GREEN}{Emoji.SUCCESS} –ó–∞–≤–µ—Ä—à–µ–Ω–æ!{Colors.RESET}")
            
    def format_time(self, seconds):
        if seconds < 60:
            return f"{seconds:.0f}—Å"
        elif seconds < 3600:
            minutes = seconds // 60
            seconds = seconds % 60
            return f"{minutes:.0f}–º {seconds:.0f}—Å"
        else:
            hours = seconds // 3600
            minutes = (seconds % 3600) // 60
            return f"{hours:.0f}—á {minutes:.0f}–º"


# ============================================================================
# –ö–õ–ê–°–° –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–ê–ó–ê–ú–ò –î–ê–ù–ù–´–•
# ============================================================================

class DatabaseManager:
    def __init__(self, logger):
        self.logger = logger
        self.local_db_path = None
        self.latest_db = self.find_latest_database()
        self.create_working_copy()
        
    def extract_date_from_filename(self, filename):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞"""
        filename_lower = filename.lower()
        name_without_ext = os.path.splitext(filename_lower)[0]
        
        patterns = [
            (r'\d{4}\.\d{2}\.\d{2}', '%Y.%m.%d'),
            (r'\d{4}-\d{2}-\d{2}', '%Y-%m-%d'),
            (r'\d{4}_\d{2}_\d{2}', '%Y_%m_%d'),
        ]
        
        for pattern, date_format in patterns:
            match = re.search(pattern, name_without_ext)
            if match:
                try:
                    return datetime.strptime(match.group(), date_format)
                except ValueError:
                    continue
        
        six_digit_match = re.search(r'(?<!\d)(\d{6})(?!\d)', name_without_ext)
        if six_digit_match:
            six_digits = six_digit_match.group(1)
            try:
                year = int(six_digits[0:2])
                month = int(six_digits[2:4])
                day = int(six_digits[4:6])
                
                if year < 50:
                    year += 2000
                elif year < 100:
                    year += 1900
                
                if 1 <= month <= 12 and 1 <= day <= 31:
                    return datetime(year, month, day)
            except ValueError:
                pass
        
        eight_digit_match = re.search(r'(?<!\d)(\d{8})(?!\d)', name_without_ext)
        if eight_digit_match:
            eight_digits = eight_digit_match.group(1)
            try:
                return datetime.strptime(eight_digits, '%Y%m%d')
            except ValueError:
                pass
        
        return None
    
    def create_sqlite_connection(self, db_path, read_only=False):
        """–°–æ–∑–¥–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å SQLite –±–∞–∑–æ–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º URI –¥–ª—è Windows"""
        try:
            # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—É—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
            db_path = os.path.abspath(db_path)
            
            # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏ —Ä–µ–∂–∏–º –∑–∞–ø–∏—Å–∏, —Å–æ–∑–¥–∞–¥–∏–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
            if not os.path.exists(db_path) and not read_only:
                # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                os.makedirs(os.path.dirname(db_path), exist_ok=True)
                # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
                with open(db_path, 'w') as f:
                    pass
                self.logger.info(f"{Emoji.FILE} –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_path}")
            
            # –î–ª—è Windows: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç, –ø–æ–Ω—è—Ç–Ω—ã–π SQLite
            # –ó–∞–º–µ–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏ –Ω–∞ –ø—Ä—è–º—ã–µ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø—Ä–æ–±–µ–ª—ã
            db_path_str = str(db_path).replace('\\', '/')
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ URI
            db_path_encoded = urllib.parse.quote(db_path_str, safe='/:')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º URI
            if read_only:
                uri = f"file:{db_path_encoded}?mode=ro"
            else:
                uri = f"file:{db_path_encoded}?mode=rw"
            
            # –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            conn = sqlite3.connect(
                uri,
                timeout=CONFIG['SQLITE_TIMEOUT'],
                uri=True,
                check_same_thread=False  # –î–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ
            )
            
            cursor = conn.cursor()
            
            # –í–∫–ª—é—á–∞–µ–º WAL —Ä–µ–∂–∏–º –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if not read_only and CONFIG['SQLITE_JOURNAL_MODE']:
                try:
                    cursor.execute(f"PRAGMA journal_mode = {CONFIG['SQLITE_JOURNAL_MODE']}")
                except Exception:
                    pass
            
            # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ SQLite
            cursor.execute("PRAGMA synchronous = NORMAL")
            cursor.execute("PRAGMA cache_size = -2000")  # 2MB –∫—ç—à–∞
            cursor.execute("PRAGMA foreign_keys = OFF")
            cursor.execute("PRAGMA temp_store = MEMORY")
            cursor.execute("PRAGMA busy_timeout = 5000")  # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            
            return conn
        except sqlite3.OperationalError as e:
            error_msg = str(e)
            if "locked" in error_msg.lower():
                self.logger.update_stats('database_locks', 1)
                self.logger.warning(f"{Emoji.LOCK} –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: {db_path}")
                time.sleep(1)
                return self.create_sqlite_connection(db_path, read_only)
            elif "unable to open database file" in error_msg.lower():
                self.logger.error(f"{Emoji.ERROR} –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_path}")
                self.logger.error(f"{Emoji.ERROR} –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞")
                # –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ
                try:
                    os.makedirs(os.path.dirname(db_path), exist_ok=True)
                    with open(db_path, 'w') as f:
                        pass
                    self.logger.info(f"{Emoji.FILE} –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...")
                    time.sleep(0.5)
                    return self.create_sqlite_connection(db_path, read_only)
                except Exception as e2:
                    self.logger.error(f"{Emoji.ERROR} –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: {e2}")
                    raise
            else:
                self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ SQLite: {error_msg}")
                raise
        except Exception as e:
            self.logger.error(f"{Emoji.ERROR} –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–∞–∑—ã {db_path}: {e}")
            raise
    
    def close_sqlite_connection(self, conn, db_path):
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å SQLite –±–∞–∑–æ–π"""
        if conn:
            try:
                # –ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
                conn.commit()
                
                # –ï—Å–ª–∏ –±–∞–∑–∞ –±—ã–ª–∞ –≤ —Ä–µ–∂–∏–º–µ WAL, –≤—ã–ø–æ–ª–Ω–∏–º checkpoint
                try:
                    cursor = conn.cursor()
                    cursor.execute("PRAGMA wal_checkpoint(TRUNCATE)")
                except:
                    pass
                
                conn.close()
            except Exception as e:
                self.logger.warning(f"{Emoji.WARNING} –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å {db_path}: {e}")
                try:
                    conn.close()
                except:
                    pass
    
    def find_latest_database(self):
        """–ù–∞—Ö–æ–¥–∏—Ç —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª –±–∞–∑—ã"""
        pattern = "ezinfo_ultimate*.db"
        files = glob.glob(pattern)
        
        if not files:
            self.logger.warning(f"{Emoji.WARNING} –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞–±–ª–æ–Ω—É ezinfo_ultimate*.db")
            self.logger.info(f"{Emoji.DATABASE} –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞.")
            return None
        
        dated_files = []
        for f in files:
            if self.extract_date_from_filename(Path(f).name) or f == "ezinfo_ultimate.db":
                dated_files.append(f)
        
        if not dated_files:
            dated_files = files
        
        try:
            dated_files_with_date = []
            for f in dated_files:
                file_date = self.extract_date_from_filename(Path(f).name)
                if file_date:
                    dated_files_with_date.append((f, file_date))
            
            if dated_files_with_date:
                dated_files_with_date.sort(key=lambda x: x[1], reverse=True)
                latest = dated_files_with_date[0][0]
                latest_date = dated_files_with_date[0][1]
                self.logger.info(f"{Emoji.SEARCH} –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –±–∞–∑–∞ –ø–æ –¥–∞—Ç–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: {Colors.CYAN}{latest}{Colors.RESET}")
                self.logger.info(f"{Emoji.CALENDAR} –î–∞—Ç–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: {latest_date.strftime('%d.%m.%Y')}")
            else:
                latest = max(dated_files, key=os.path.getmtime)
                mod_time = datetime.fromtimestamp(os.path.getmtime(latest))
                self.logger.info(f"{Emoji.SEARCH} –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –±–∞–∑–∞ –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {Colors.CYAN}{latest}{Colors.RESET}")
                self.logger.info(f"{Emoji.CLOCK} –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {mod_time.strftime('%d.%m.%Y %H:%M:%S')}")
            
            return latest
        except Exception as e:
            self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –±–∞–∑—ã: {e}")
            return None
    
    def create_working_copy(self):
        current_time = datetime.now().strftime("%d.%m.%Y_%H%M%S")
        
        if self.latest_db and os.path.exists(self.latest_db):
            base_name = Path(self.latest_db).stem
            
            file_date = self.extract_date_from_filename(Path(self.latest_db).name)
            if file_date:
                date_str = file_date.strftime('%Y%m%d')
                date_patterns = [
                    file_date.strftime('%Y.%m.%d'),
                    file_date.strftime('%Y-%m-%d'),
                    file_date.strftime('%Y_%m_%d'),
                    date_str,
                ]
                
                for pattern in date_patterns:
                    if pattern in base_name:
                        base_name = base_name.replace(pattern, '').strip('_').strip('-').strip()
                        break
            
            self.local_db_path = f"ezinfo_ultimate_{current_time}.db"
            
            try:
                self.logger.info(f"{Emoji.COPY} –°–æ–∑–¥–∞—é –∫–æ–ø–∏—é –±–∞–∑—ã...")
                
                # –ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª
                shutil.copy2(self.latest_db, self.local_db_path)
                
                self.logger.info(f"{Emoji.SUCCESS} –°–æ–∑–¥–∞–Ω–∞ –∫–æ–ø–∏—è: {Colors.GREEN}{self.local_db_path}{Colors.RESET}")
            except Exception as e:
                self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–∞–∑—ã: {e}")
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø—É—Å—Ç—É—é –±–∞–∑—É
                self.local_db_path = f"ezinfo_ultimate_{current_time}.db"
                self.create_new_database()
        else:
            self.local_db_path = f"ezinfo_ultimate_{current_time}.db"
            self.create_new_database()
        
        self.ensure_database_structure()
    
    def create_new_database(self):
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        try:
            # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            os.makedirs(os.path.dirname(self.local_db_path), exist_ok=True)
            
            # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
            with open(self.local_db_path, 'w') as f:
                pass
            
            self.logger.info(f"{Emoji.DATABASE} –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {Colors.GREEN}{self.local_db_path}{Colors.RESET}")
        except Exception as e:
            self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –±–∞–∑—ã: {e}")
            # –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            self.local_db_path = f"ezinfo_ultimate_{datetime.now().strftime('%d.%m.%Y_%H%M%S')}.db"
            with open(self.local_db_path, 'w') as f:
                pass
            self.logger.info(f"{Emoji.DATABASE} –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {self.local_db_path}")
    
    def ensure_database_structure(self):
        """–°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
        conn = None
        try:
            conn = self.create_sqlite_connection(self.local_db_path, read_only=False)
            cursor = conn.cursor()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–±–ª–∏—Ü–∞ players
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='players'")
            if not cursor.fetchone():
                self.logger.info(f"{Emoji.DATABASE} –°–æ–∑–¥–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
                
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS players (
                        ez_id TEXT PRIMARY KEY,
                        forum_name TEXT,
                        name TEXT,
                        level INTEGER,
                        gs INTEGER,
                        ilvl INTEGER,
                        class TEXT,
                        race TEXT,
                        guild TEXT,
                        kills INTEGER,
                        ap INTEGER,
                        pers_online BOOLEAN,
                        forum_online BOOLEAN,
                        source TEXT,
                        scan_date TEXT,
                        status TEXT DEFAULT 'live',
                        firstTimeSeen TEXT,
                        lastSeen TEXT,
                        lastUpdated TEXT
                    )
                ''')
                
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_ez_id ON players (ez_id)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_status ON players (status)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_name ON players (name)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_guild ON players (guild)')
                
                conn.commit()
                self.logger.info(f"{Emoji.SUCCESS} –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞")
            else:
                self.logger.info(f"{Emoji.CHECK} –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                
        except Exception as e:
            self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã: {e}")
            raise
        finally:
            if conn:
                self.close_sqlite_connection(conn, self.local_db_path)
    
    def sort_files_by_date(self, files):
        """–°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –ø–æ –¥–∞—Ç–µ"""
        files_with_dates = []
        
        for file in files:
            filename = Path(file).name
            file_date = self.extract_date_from_filename(filename)
            
            if file_date:
                files_with_dates.append((file, file_date, filename))
            else:
                files_with_dates.append((file, datetime.min, filename))
        
        files_with_dates.sort(key=lambda x: (x[1], x[2]))
        
        return [file for file, _, _ in files_with_dates]
    
    def find_all_tables(self, conn, is_tech_db=False):
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = [row[0] for row in cursor.fetchall()]
        
        if not tables:
            raise ValueError("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü")
        
        if not is_tech_db:
            return self.find_main_table(conn, tables)
        else:
            return self.find_tech_tables(conn, tables)
    
    def find_main_table(self, conn, tables):
        table_stats = []
        
        for table_name in tables:
            if table_name.startswith('sqlite_'):
                continue
                
            try:
                cursor = conn.cursor()
                cursor.execute(f"SELECT COUNT(*) FROM {table_name}")
                count = cursor.fetchone()[0]
                table_stats.append((table_name, count))
            except:
                continue
        
        if not table_stats:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏")
        
        table_stats.sort(key=lambda x: x[1], reverse=True)
        
        main_table = table_stats[0][0]
        self.logger.info(f"{Emoji.DATABASE} –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–±—Ä–∞–Ω–∞: {Colors.CYAN}{main_table}{Colors.RESET} ({table_stats[0][1]} –∑–∞–ø–∏—Å–µ–π)")
        
        return [(main_table, table_stats[0][1])]
    
    def find_tech_tables(self, conn, tables):
        table_stats = []
        
        for table_name in tables:
            if table_name.startswith('sqlite_'):
                continue
                
            try:
                cursor = conn.cursor()
                cursor.execute(f"SELECT COUNT(*) FROM {table_name}")
                count = cursor.fetchone()[0]
                
                if count >= CONFIG['TECH_TABLE_MIN_RECORDS']:
                    table_stats.append((table_name, count))
            except:
                continue
        
        if not table_stats:
            raise ValueError(f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π (–º–∏–Ω–∏–º—É–º {CONFIG['TECH_TABLE_MIN_RECORDS']})")
        
        table_stats.sort(key=lambda x: x[1], reverse=True)
        
        self.logger.info(f"{Emoji.GEAR} –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü –≤ tech –±–∞–∑–µ: {len(table_stats)}")
        for table_name, count in table_stats:
            self.logger.info(f"  üìä {table_name}: {count} –∑–∞–ø–∏—Å–µ–π")
        
        return table_stats
    
    def check_table_structure(self, conn, table_name):
        cursor = conn.cursor()
        cursor.execute(f"PRAGMA table_info({table_name})")
        columns_info = cursor.fetchall()
        
        if not columns_info:
            raise ValueError(f"–¢–∞–±–ª–∏—Ü–∞ {table_name} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–æ–∫")
        
        column_names = [col[1] for col in columns_info]
        
        required_columns = ['ez_id', 'name']
        missing_columns = [col for col in required_columns if col not in column_names]
        
        if missing_columns:
            for col in missing_columns[:]:
                for existing_col in column_names:
                    if col.lower() in existing_col.lower():
                        missing_columns.remove(col)
                        break
        
        if missing_columns:
            raise ValueError(
                f"–í —Ç–∞–±–ª–∏—Ü–µ {table_name} –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}"
            )
        
        return column_names
    
    def extract_ez_id(self, player_dict, column_names, base_name, table_name):
        ez_id = None
        
        for col in column_names:
            if 'id' in col.lower() and player_dict.get(col) is not None:
                ez_id = player_dict[col]
                break
        
        if ez_id is None:
            return None
        
        ez_id_str = str(ez_id).strip()
        
        if not ez_id_str or ez_id_str.lower() in ['none', 'null']:
            return None
        
        return ez_id_str
    
    def extract_player_info(self, player_dict, column_names):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
        name = None
        forum_name = None
        
        # –ò—â–µ–º –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        for col in column_names:
            if 'name' in col.lower() and col.lower() != 'forum_name':
                if player_dict.get(col):
                    name = player_dict[col]
                    break
        
        # –ò—â–µ–º –∏–º—è —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
        for col in column_names:
            if 'forum' in col.lower() or 'account' in col.lower() or 'login' in col.lower():
                if player_dict.get(col):
                    forum_name = player_dict[col]
                    break
        
        return name, forum_name
    
    def get_target_db_info(self, target_db_path):
        if not os.path.exists(target_db_path):
            raise FileNotFoundError(f"–¶–µ–ª–µ–≤–∞—è –±–∞–∑–∞ {target_db_path} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        conn = None
        try:
            conn = self.create_sqlite_connection(target_db_path, read_only=True)
            filename = Path(target_db_path).name.lower()
            is_tech_db = 'tech' in filename and CONFIG['PROCESS_TECH_BASES']
            
            tables_info = self.find_all_tables(conn, is_tech_db)
            
            tables_data = []
            for table_name, record_count in tables_info:
                column_names = self.check_table_structure(conn, table_name)
                tables_data.append({
                    'name': table_name,
                    'columns': column_names,
                    'record_count': record_count
                })
            
            return conn, tables_data, is_tech_db
        except Exception as e:
            if conn:
                self.close_sqlite_connection(conn, target_db_path)
            raise e
    
    def map_columns(self, source_columns, target_columns):
        column_map = {}
        
        for target_col in target_columns:
            if target_col in source_columns:
                column_map[target_col] = target_col
            else:
                target_lower = target_col.lower()
                for source_col in source_columns:
                    if source_col.lower() == target_lower:
                        column_map[target_col] = source_col
                        break
                else:
                    for source_col in source_columns:
                        if target_lower in source_col.lower() or source_col.lower() in target_lower:
                            column_map[target_col] = source_col
                            break
                    else:
                        column_map[target_col] = None
        
        return column_map
    
    def is_local_db_empty(self):
        conn = None
        try:
            conn = self.create_sqlite_connection(self.local_db_path, read_only=True)
            cursor = conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM players")
            count = cursor.fetchone()[0]
            return count == 0
        except sqlite3.Error as e:
            self.logger.error(f"{Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–∑—ã: {e}")
            return True
        finally:
            if conn:
                self.close_sqlite_connection(conn, self.local_db_path)
    
    def handle_duplicate_id(self, ez_id, player_dict, column_names, base_name, table_name, existing_ids_cache=None):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã ID - —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        if not CONFIG['HANDLE_DUPLICATE_IDS']:
            return None, False
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        name, forum_name = self.extract_player_info(player_dict, column_names)
        
        # –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –∫—ç—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ID, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if existing_ids_cache is not None:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π ID —É–∂–µ –≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö
            if ez_id in existing_ids_cache:
                duplicate_counter = 1
                new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                
                # –ò—â–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                while new_ez_id in existing_ids_cache:
                    duplicate_counter += 1
                    new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π ID –≤ –∫—ç—à
                existing_ids_cache.add(new_ez_id)
                
                # –õ–æ–≥–∏—Ä—É–µ–º —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                self.logger.warning(f"  {Emoji.WARNING} –î—É–±–ª–∏–∫–∞—Ç ID –≤ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑–µ:")
                self.logger.warning(f"    –¢–∞–±–ª–∏—Ü–∞: {table_name}")
                self.logger.warning(f"    ID: {ez_id} ‚Üí {new_ez_id}")
                if name:
                    self.logger.warning(f"    –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: {name}")
                if forum_name:
                    self.logger.warning(f"    –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å: {forum_name}")
                self.logger.update_stats('duplicate_ids', 1)
                
                player_dict['ez_id'] = new_ez_id
                return new_ez_id, True
        
        return ez_id, False
    
    def process_database(self, target_db_path):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é"""
        max_attempts = 3
        
        for attempt in range(max_attempts):
            try:
                return self._process_database_internal(target_db_path, attempt + 1, max_attempts)
            except sqlite3.OperationalError as e:
                if "locked" in str(e).lower() and attempt < max_attempts - 1:
                    self.logger.update_stats('database_locks', 1)
                    self.logger.warning(f"{Emoji.LOCK} –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts}")
                    time.sleep(2 ** attempt)
                    continue
                raise
    
    def _process_database_internal(self, target_db_path, attempt, max_attempts):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        if attempt > 1:
            self.logger.info(f"{Emoji.PROCESS} –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑—ã (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{max_attempts}): {Colors.CYAN}{target_db_path}{Colors.RESET}")
        else:
            self.logger.info(f"{Emoji.PROCESS} –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑—ã: {Colors.CYAN}{target_db_path}{Colors.RESET}")
        
        target_conn = None
        local_conn = None
        
        try:
            target_conn, tables_data, is_tech_db = self.get_target_db_info(target_db_path)
            target_name = Path(target_db_path).stem
            
            local_conn = self.create_sqlite_connection(self.local_db_path, read_only=False)
            local_cursor = local_conn.cursor()
            
            current_time = datetime.now().isoformat()
            local_columns = [
                'ez_id', 'forum_name', 'name', 'level', 'gs', 'ilvl', 
                'class', 'race', 'guild', 'kills', 'ap', 'pers_online', 
                'forum_online', 'source', 'scan_date'
            ]
            
            stats = {
                'new_players': 0,
                'updated_players': 0,
                'out_players': 0,
                'restored_players': 0
            }
            
            # –ó–ê–ì–†–£–ñ–ê–ï–ú –í–°–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï ID –ò–ó –õ–û–ö–ê–õ–¨–ù–û–ô –ë–ê–ó–´ –í –ü–ê–ú–Ø–¢–¨
            # –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —Å–æ—Ç–Ω–∏ —Ä–∞–∑!
            local_cursor.execute("SELECT ez_id, status, firstTimeSeen, lastSeen FROM players")
            local_players = {}
            existing_ids = set()
            
            for row in local_cursor.fetchall():
                ez_id = row[0]
                local_players[ez_id] = {
                    'status': row[1],
                    'firstTimeSeen': row[2],
                    'lastSeen': row[3]
                }
                existing_ids.add(ez_id)
            
            all_target_players = {}
            seen_players_in_target = set()
            processed_ids_in_target = set()  # –ö—ç—à –¥–ª—è ID –≤–Ω—É—Ç—Ä–∏ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã
            
            # –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã –≤ –ø–∞–º—è—Ç—å
            total_records = 0
            for table_info in tables_data:
                total_records += table_info['record_count']
            
            self.logger.info(f"{Emoji.DATABASE} –ó–∞–≥—Ä—É–∑–∫–∞ {total_records} –∑–∞–ø–∏—Å–µ–π –∏–∑ {len(tables_data)} —Ç–∞–±–ª–∏—Ü...")
            
            for table_info in tables_data:
                table_name = table_info['name']
                column_names = table_info['columns']
                
                if is_tech_db:
                    self.logger.info(f"  {Emoji.DATABASE} –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã: {table_name}")
                
                column_map = self.map_columns(column_names, local_columns)
                
                target_cursor = target_conn.cursor()
                target_cursor.execute(f"SELECT * FROM {table_name}")
                table_players = target_cursor.fetchall()
                
                for row in table_players:
                    player_dict = dict(zip(column_names, row))
                    
                    ez_id = self.extract_ez_id(player_dict, column_names, target_name, table_name)
                    if ez_id is None:
                        continue
                    
                    if is_tech_db:
                        seen_players_in_target.add(ez_id)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã
                    if ez_id in processed_ids_in_target:
                        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                        new_ez_id, is_duplicate = self.handle_duplicate_id(
                            ez_id, player_dict, column_names, target_name, table_name, processed_ids_in_target
                        )
                        if new_ez_id is None:
                            continue
                        ez_id = new_ez_id
                    else:
                        processed_ids_in_target.add(ez_id)
                    
                    if ez_id not in all_target_players:
                        all_target_players[ez_id] = {
                            'data': player_dict,
                            'column_map': column_map,
                            'source': f"{target_name}",
                            'table_name': table_name,
                            'column_names': column_names
                        }
            
            # –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ—Ö —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            if all_target_players:
                if is_tech_db:
                    self.logger.info(f"  {Emoji.GEAR} Tech –±–∞–∑–∞: —Å–æ–±—Ä–∞–Ω–æ {len(seen_players_in_target)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ {len(tables_data)} —Ç–∞–±–ª–∏—Ü")
                
                progress = ProgressBar(
                    total=len(all_target_players),
                    prefix=f'{Emoji.SYNC} –û–±—Ä–∞–±–æ—Ç–∫–∞ {target_name}',
                    suffix='–∏–≥—Ä–æ–∫–æ–≤',
                    length=30
                )
                
                # –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
                batch_size = 100
                insert_batch = []
                update_batch = []
                
                for i, (ez_id, player_info) in enumerate(all_target_players.items()):
                    player_dict = player_info['data']
                    column_map = player_info['column_map']
                    source_name = player_info['source']
                    column_names = player_info['column_names']
                    
                    player_data = []
                    for local_col in local_columns:
                        source_col = column_map[local_col]
                        if source_col and source_col in player_dict:
                            player_data.append(player_dict[source_col])
                        else:
                            player_data.append(None)
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    name, forum_name = self.extract_player_info(player_dict, column_names)
                    
                    if ez_id in local_players:
                        local_info = local_players[ez_id]
                        
                        was_out = local_info['status'] == 'out'
                        
                        update_parts = []
                        update_values = []
                        
                        for idx, local_col in enumerate(local_columns):
                            if local_col != 'ez_id':
                                update_parts.append(f"{local_col} = ?")
                                update_values.append(player_data[idx])
                        
                        update_parts.append("lastUpdated = ?")
                        update_values.append(current_time)
                        
                        if was_out:
                            update_parts.append("status = ?")
                            update_values.append('live')
                            update_parts.append("lastSeen = NULL")
                            stats['restored_players'] += 1
                        
                        sql = f"UPDATE players SET {', '.join(update_parts)} WHERE ez_id = ?"
                        update_values.append(ez_id)
                        
                        try:
                            local_cursor.execute(sql, update_values)
                            stats['updated_players'] += 1
                        except sqlite3.Error as e:
                            self.logger.error(f"    {Emoji.ERROR} –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ {ez_id}: {e}")
                            
                            # –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å —Å –∑–∞–º–µ–Ω–æ–π
                            try:
                                player_data_ordered = [player_data[local_columns.index('ez_id')]]
                                for local_col in local_columns:
                                    if local_col != 'ez_id':
                                        player_data_ordered.append(player_data[local_columns.index(local_col)])
                                
                                first_time_seen = local_info['firstTimeSeen'] if local_info['firstTimeSeen'] else source_name
                                
                                player_data_ordered.extend(['live', first_time_seen, None, current_time])
                                
                                placeholders = ', '.join(['?'] * (len(local_columns) + 4))
                                columns_sql = ', '.join(local_columns + ['status', 'firstTimeSeen', 'lastSeen', 'lastUpdated'])
                                
                                local_cursor.execute(f'''
                                    INSERT OR REPLACE INTO players ({columns_sql})
                                    VALUES ({placeholders})
                                ''', player_data_ordered)
                                stats['updated_players'] += 1
                            except sqlite3.Error as e2:
                                self.logger.error(f"    {Emoji.ERROR} –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–≥—Ä–æ–∫–∞ {ez_id}: {e2}")
                    else:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π
                        if ez_id in existing_ids:
                            # –î–£–ë–õ–ò–ö–ê–¢ –ú–ï–ñ–î–£ –ë–ê–ó–ê–ú–ò - –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ
                            self.logger.warning(f"  {Emoji.WARNING} –î—É–±–ª–∏–∫–∞—Ç ID –º–µ–∂–¥—É –±–∞–∑–∞–º–∏:")
                            self.logger.warning(f"    –¢–∞–±–ª–∏—Ü–∞: {player_info['table_name']}")
                            self.logger.warning(f"    ID: {ez_id}")
                            if name:
                                self.logger.warning(f"    –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: {name}")
                            if forum_name:
                                self.logger.warning(f"    –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å: {forum_name}")
                            
                            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                            duplicate_counter = 1
                            new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                            
                            while new_ez_id in existing_ids:
                                duplicate_counter += 1
                                new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                            
                            self.logger.warning(f"    –ù–æ–≤—ã–π ID: {new_ez_id}")
                            self.logger.update_stats('duplicate_ids', 1)
                            
                            player_data[local_columns.index('ez_id')] = new_ez_id
                            ez_id = new_ez_id
                            existing_ids.add(ez_id)
                        
                        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                        player_data_ordered = [player_data[local_columns.index('ez_id')]]
                        
                        for local_col in local_columns:
                            if local_col != 'ez_id':
                                player_data_ordered.append(player_data[local_columns.index(local_col)])
                        
                        first_time_seen = source_name
                        
                        player_data_ordered.extend(['live', first_time_seen, None, current_time])
                        
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–∫–µ—Ç–Ω—É—é –≤—Å—Ç–∞–≤–∫—É –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                        insert_batch.append(player_data_ordered)
                        
                        if len(insert_batch) >= batch_size:
                            self._execute_batch_insert(local_cursor, local_columns, insert_batch)
                            stats['new_players'] += len(insert_batch)
                            insert_batch = []
                        
                        # –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à
                        existing_ids.add(ez_id)
                    
                    if i % 50 == 0 or i == len(all_target_players) - 1:
                        progress.update(i + 1)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–∞–∫–µ—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                if insert_batch:
                    self._execute_batch_insert(local_cursor, local_columns, insert_batch)
                    stats['new_players'] += len(insert_batch)
            
            # –ü–æ–º–µ—á–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–∫ 'out'
            if is_tech_db:
                missing_ids = set(local_players.keys()) - seen_players_in_target
            else:
                missing_ids = set(local_players.keys()) - set(all_target_players.keys())
            
            if missing_ids:
                self.logger.info(f"  {Emoji.PLAYER} –ü–æ–º–µ—á–∞—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤: {len(missing_ids)}")
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                batch_updates = []
                for ez_id in missing_ids:
                    local_info = local_players[ez_id]
                    if local_info['status'] != 'out':
                        batch_updates.append(('out', target_name, current_time, ez_id))
                        stats['out_players'] += 1
                
                if batch_updates:
                    local_cursor.executemany('''
                        UPDATE players 
                        SET status = ?, lastSeen = ?, lastUpdated = ?
                        WHERE ez_id = ?
                    ''', batch_updates)
            
            local_conn.commit()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            local_cursor.execute("SELECT COUNT(*) FROM players")
            self.logger.update_stats('total_players', local_cursor.fetchone()[0])
            local_cursor.execute("SELECT COUNT(*) FROM players WHERE status = 'live'")
            self.logger.update_stats('live_players', local_cursor.fetchone()[0])
            
            self.logger.update_stats('new_players', stats['new_players'])
            self.logger.update_stats('updated_players', stats['updated_players'])
            self.logger.update_stats('out_players', stats['out_players'])
            self.logger.update_stats('restored_players', stats['restored_players'])
            
            self.logger.info(f"  {Emoji.SUCCESS} –†–µ–∑—É–ª—å—Ç–∞—Ç: {Colors.GREEN}+{stats['new_players']}{Colors.RESET} –Ω–æ–≤—ã—Ö, "
                           f"{Colors.BLUE}‚Üª{stats['updated_players']}{Colors.RESET} –æ–±–Ω–æ–≤–ª–µ–Ω–æ, "
                           f"{Colors.MAGENTA}‚ôª{stats['restored_players']}{Colors.RESET} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, "
                           f"{Colors.YELLOW}‚úó{stats['out_players']}{Colors.RESET} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö")
            
            return True
            
        finally:
            if target_conn:
                self.close_sqlite_connection(target_conn, target_db_path)
            if local_conn:
                self.close_sqlite_connection(local_conn, self.local_db_path)
    
    def _execute_batch_insert(self, cursor, local_columns, batch):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–∫–µ—Ç–Ω—É—é –≤—Å—Ç–∞–≤–∫—É –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã"""
        if not batch:
            return
        
        placeholders = ', '.join(['?'] * (len(local_columns) + 4))
        columns_sql = ', '.join(local_columns + ['status', 'firstTimeSeen', 'lastSeen', 'lastUpdated'])
        
        sql = f'''
            INSERT INTO players ({columns_sql})
            VALUES ({placeholders})
        '''
        
        try:
            cursor.executemany(sql, batch)
        except sqlite3.IntegrityError as e:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –ø–∞–∫–µ—Ç–µ, –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
            self.logger.warning(f"{Emoji.WARNING} –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –ø–∞–∫–µ—Ç–Ω–æ–π –≤—Å—Ç–∞–≤–∫–µ, –≤—Å—Ç–∞–≤–ª—è—é –ø–æ –æ–¥–Ω–æ–º—É...")
            for player_data in batch:
                try:
                    cursor.execute(sql, player_data)
                except sqlite3.IntegrityError:
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –ø–∞–∫–µ—Ç–Ω–æ–π –≤—Å—Ç–∞–≤–∫–µ
                    pass
    
    def copy_entire_database(self, target_db_path):
        """–ö–æ–ø–∏—Ä—É–µ—Ç –≤—Å—é –±–∞–∑—É —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        max_attempts = 3
        
        for attempt in range(max_attempts):
            try:
                return self._copy_entire_database_internal(target_db_path, attempt + 1, max_attempts)
            except sqlite3.OperationalError as e:
                if "locked" in str(e).lower() and attempt < max_attempts - 1:
                    self.logger.update_stats('database_locks', 1)
                    self.logger.warning(f"{Emoji.LOCK} –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_attempts}")
                    time.sleep(2 ** attempt)
                    continue
                raise
    
    def _copy_entire_database_internal(self, target_db_path, attempt, max_attempts):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π"""
        if attempt > 1:
            self.logger.info(f"{Emoji.COPY} –ü–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{max_attempts})...")
        else:
            self.logger.info(f"{Emoji.COPY} –ü–æ–ª–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã...")
        
        target_conn = None
        local_conn = None
        
        try:
            target_conn, tables_data, is_tech_db = self.get_target_db_info(target_db_path)
            target_name = Path(target_db_path).stem
            
            local_conn = self.create_sqlite_connection(self.local_db_path, read_only=False)
            local_cursor = local_conn.cursor()
            
            current_time = datetime.now().isoformat()
            local_columns = [
                'ez_id', 'forum_name', 'name', 'level', 'gs', 'ilvl', 
                'class', 'race', 'guild', 'kills', 'ap', 'pers_online', 
                'forum_online', 'source', 'scan_date'
            ]
            
            total_players = 0
            seen_player_ids = set()
            duplicate_counter = 0
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ID –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            local_cursor.execute("SELECT ez_id FROM players")
            existing_ids = {row[0] for row in local_cursor.fetchall()}
            
            for table_info in tables_data:
                table_name = table_info['name']
                column_names = table_info['columns']
                
                if is_tech_db:
                    self.logger.info(f"  {Emoji.DATABASE} –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: {table_name}")
                
                column_map = self.map_columns(column_names, local_columns)
                
                target_cursor = target_conn.cursor()
                target_cursor.execute(f"SELECT * FROM {table_name}")
                players = target_cursor.fetchall()
                
                if not players:
                    continue
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–∫–µ—Ç–Ω—É—é –≤—Å—Ç–∞–≤–∫—É –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                batch_size = 100
                insert_batch = []
                
                progress = ProgressBar(
                    total=len(players),
                    prefix=f'{Emoji.COPY} –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ {table_name}',
                    suffix='–∑–∞–ø–∏—Å–µ–π',
                    length=30
                )
                
                for i, player in enumerate(players):
                    player_dict = dict(zip(column_names, player))
                    
                    ez_id = self.extract_ez_id(player_dict, column_names, target_name, table_name)
                    if ez_id is None:
                        progress.update(i + 1)
                        continue
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    name, forum_name = self.extract_player_info(player_dict, column_names)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                    original_ez_id = ez_id
                    if ez_id in seen_player_ids or ez_id in existing_ids:
                        duplicate_counter += 1
                        new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                        
                        # –ò—â–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                        while new_ez_id in seen_player_ids or new_ez_id in existing_ids:
                            duplicate_counter += 1
                            new_ez_id = f"{ez_id}{CONFIG['DUPLICATE_SUFFIX']}{duplicate_counter}"
                        
                        player_dict['ez_id'] = new_ez_id
                        ez_id = new_ez_id
                        
                        # –õ–æ–≥–∏—Ä—É–µ–º —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                        self.logger.warning(f"    {Emoji.WARNING} –î—É–±–ª–∏–∫–∞—Ç ID:")
                        self.logger.warning(f"      –¢–∞–±–ª–∏—Ü–∞: {table_name}")
                        self.logger.warning(f"      ID: {original_ez_id} ‚Üí {ez_id}")
                        if name:
                            self.logger.warning(f"      –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: {name}")
                        if forum_name:
                            self.logger.warning(f"      –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å: {forum_name}")
                        self.logger.update_stats('duplicate_ids', 1)
                    
                    seen_player_ids.add(ez_id)
                    existing_ids.add(ez_id)
                    
                    player_data = []
                    for local_col in local_columns:
                        source_col = column_map[local_col]
                        if source_col and source_col in player_dict:
                            player_data.append(player_dict[source_col])
                        else:
                            player_data.append(None)
                    
                    source_name = target_name
                    player_data.extend(['live', source_name, None, current_time])
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞–∫–µ—Ç –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                    insert_batch.append(player_data)
                    total_players += 1
                    
                    # –ï—Å–ª–∏ –Ω–∞–±—Ä–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–∞–∫–µ—Ç–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Å—Ç–∞–≤–∫—É
                    if len(insert_batch) >= batch_size:
                        self._execute_batch_insert(local_cursor, local_columns, insert_batch)
                        insert_batch = []
                    
                    if i % 50 == 0 or i == len(players) - 1:
                        progress.update(i + 1)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø–∏—Å–∏
                if insert_batch:
                    self._execute_batch_insert(local_cursor, local_columns, insert_batch)
            
            local_conn.commit()
            
            if is_tech_db:
                self.logger.info(f"  {Emoji.GEAR} Tech –±–∞–∑–∞: —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ {len(seen_player_ids)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ {len(tables_data)} —Ç–∞–±–ª–∏—Ü")
            
            self.logger.update_stats('new_players', total_players)
            self.logger.info(f"{Emoji.SUCCESS} –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ {total_players} –∑–∞–ø–∏—Å–µ–π –∏–∑ {target_name}")
            
            return True
            
        finally:
            if target_conn:
                self.close_sqlite_connection(target_conn, target_db_path)
            if local_conn:
                self.close_sqlite_connection(local_conn, self.local_db_path)
    
    def show_statistics(self):
        self.logger.info(f"{Emoji.STATS} –ó–∞–≥—Ä—É–∂–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
        
        conn = None
        try:
            conn = self.create_sqlite_connection(self.local_db_path, read_only=True)
            cursor = conn.cursor()
            
            cursor.execute("SELECT COUNT(*) FROM players")
            total = cursor.fetchone()[0]
            
            cursor.execute("SELECT COUNT(*) FROM players WHERE status = 'live'")
            live = cursor.fetchone()[0]
            
            cursor.execute("SELECT COUNT(*) FROM players WHERE status = 'out'")
            out = cursor.fetchone()[0]
            
            cursor.execute("SELECT COUNT(DISTINCT firstTimeSeen) FROM players WHERE firstTimeSeen IS NOT NULL")
            sources = cursor.fetchone()[0]
            
            cursor.execute("SELECT COUNT(DISTINCT guild) FROM players WHERE status = 'live' AND guild IS NOT NULL AND guild != ''")
            active_guilds = cursor.fetchone()[0]
            
            self.header(f"{Emoji.STATS} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö {Emoji.STATS}")
            self.logger.info(f"üìä –í—Å–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:       {Colors.BOLD}{total}{Colors.RESET}")
            self.logger.info(f"{Emoji.FIRE} –ê–∫—Ç–∏–≤–Ω—ã—Ö (live):        {Colors.GREEN}{live}{Colors.RESET} ({live/total*100:.1f}%)")
            self.logger.info(f"{Emoji.GHOST} –ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö (out):       {Colors.YELLOW}{out}{Colors.RESET} ({out/total*100:.1f}%)")
            self.logger.info(f"{Emoji.SOURCE} –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö:      {sources}")
            self.logger.info(f"{Emoji.GUILD} –ê–∫—Ç–∏–≤–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π:       {active_guilds}")
            
            if total > 0:
                cursor.execute("""
                    SELECT guild, COUNT(*) as count 
                    FROM players 
                    WHERE status = 'live' AND guild IS NOT NULL AND guild != ''
                    GROUP BY guild 
                    ORDER BY count DESC 
                    LIMIT 10
                """)
                guilds = cursor.fetchall()
                
                if guilds:
                    self.subheader(f"{Emoji.TROPHY} –¢–û–ü-10 –ì–ò–õ–¨–î–ò–ô (–ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∏–≥—Ä–æ–∫–∞–º):")
                    for i, (guild, count) in enumerate(guilds, 1):
                        percentage = count / live * 100
                        medal = ""
                        if i == 1: medal = "ü•á"
                        elif i == 2: medal = "ü•à"
                        elif i == 3: medal = "ü•â"
                        else: medal = f"{i}."
                        self.logger.info(f"  {medal} {guild[:40]:40} {Colors.CYAN}{count:4}{Colors.RESET} –∏–≥—Ä. {percentage:5.1f}%")
                
                cursor.execute("""
                    SELECT class, COUNT(*) as count 
                    FROM players 
                    WHERE status = 'live' AND class IS NOT NULL AND class != ''
                    GROUP BY class 
                    ORDER BY count DESC
                """)
                classes = cursor.fetchall()
                
                if classes:
                    self.subheader(f"{Emoji.SWORDS} –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ö–õ–ê–°–°–ê–ú:")
                    for class_name, count in classes:
                        percentage = count / live * 100
                        self.logger.info(f"  {class_name[:20]:20} {Colors.MAGENTA}{count:4}{Colors.RESET} –∏–≥—Ä. {percentage:5.1f}%")
                
                cursor.execute("""
                    SELECT firstTimeSeen, COUNT(*) as count 
                    FROM players 
                    WHERE firstTimeSeen IS NOT NULL
                    GROUP BY firstTimeSeen 
                    ORDER BY count DESC
                    LIMIT 10
                """)
                sources_stats = cursor.fetchall()
                
                if sources_stats:
                    self.subheader(f"{Emoji.MAGNIFYING_GLASS} –¢–û–ü-10 –ò–°–¢–û–ß–ù–ò–ö–û–í:")
                    for source, count in sources_stats:
                        percentage = count / total * 100
                        self.logger.info(f"  {source[:40]:40} {Colors.GREEN}{count:4}{Colors.RESET} –∏–≥—Ä. ({percentage:.1f}%)")
        
        finally:
            if conn:
                self.close_sqlite_connection(conn, self.local_db_path)


# ============================================================================
# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –§–ê–ô–õ–ê–ú–ò –ò –ü–ê–ü–ö–ê–ú–ò
# ============================================================================

def collect_database_files(path):
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏"""
    database_files = []
    
    if os.path.isfile(path):
        database_files.append(path)
    elif os.path.isdir(path):
        for root, dirs, files in os.walk(path):
            for file in files:
                if file.lower().endswith('.db'):
                    full_path = os.path.join(root, file)
                    database_files.append(full_path)
    else:
        raise FileNotFoundError(f"–ü—É—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {path}")
    
    return database_files


def should_skip_file(filename):
    filename_lower = filename.lower()
    
    for pattern in CONFIG['SKIP_PATTERNS']:
        if pattern.lower() in filename_lower:
            return True
    
    if 'tech' in filename_lower and not CONFIG['PROCESS_TECH_BASES']:
        return True
    
    return False


def ask_for_target_path(logger, is_continue=False):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—É—Ç—å –∫ —Ü–µ–ª–µ–≤–æ–π –±–∞–∑–µ –∏–ª–∏ –ø–∞–ø–∫–µ"""
    if not is_continue:
        logger.separator()
        logger.header(f"{Emoji.WAVING_HAND} –í–≤–æ–¥ –ø—É—Ç–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø–∞–ø–∫–µ {Emoji.FOLDER}")
    else:
        logger.separator()
        logger.header(f"{Emoji.ARROW_RIGHT} –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞/–ø–∞–ø–∫–∏")
    
    logger.info(f"{Emoji.BULLET} –ü—Ä–∏–º–µ—Ä—ã:")
    logger.info(f"  {Emoji.FILE} 2024.08.08.db                # –§–∞–π–ª —Å –¥–∞—Ç–æ–π")
    logger.info(f"  {Emoji.FILE} ezbase_final_251123_1228.db  # –§–∞–π–ª —Å –¥–∞—Ç–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ú–ú–î–î")
    logger.info(f"  {Emoji.FOLDER} /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ/               # –í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ")
    logger.info(f"  {Emoji.FILE} C:\\–±–∞–∑—ã\\players.db         # –§–∞–π–ª")
    logger.info("")
    logger.info(f"{Emoji.EXIT} –í–≤–µ–¥–∏—Ç–µ 'q' –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã")
    logger.info(f"{Emoji.STOP} –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
    logger.separator('‚îÄ')
    
    while True:
        try:
            if is_continue:
                prompt = f"\n{Emoji.QUESTION} –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ –ø–∞–ø–∫–µ (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞): "
            else:
                prompt = f"\n{Emoji.QUESTION} –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –ø–∞–ø–∫–µ: "
            
            target_path = input(f"{Colors.CYAN}{prompt}{Colors.RESET}").strip()
            
            if target_path.lower() == 'q':
                return None
            
            if not target_path:
                logger.warning(f"{Emoji.WARNING} –ü—É—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
                continue
            
            if os.path.exists(target_path):
                logger.info(f"{Emoji.CHECK} –í—ã–±—Ä–∞–Ω –ø—É—Ç—å: {Colors.GREEN}{target_path}{Colors.RESET}")
                return target_path
            else:
                logger.error(f"{Emoji.ERROR} –ü—É—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {target_path}")
                logger.info(f"{Emoji.INFO} –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        except KeyboardInterrupt:
            logger.info(f"\n\n{Emoji.STOP} ‚ö†  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
            sys.exit(0)


def process_path(path, logger, db_manager):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É—Ç—å (—Ñ–∞–π–ª –∏–ª–∏ –ø–∞–ø–∫—É)"""
    if os.path.isfile(path):
        db_files = [path]
    else:
        db_files = collect_database_files(path)
        
        if not db_files:
            logger.error(f"{Emoji.ERROR} –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!")
            return False
        
        db_files = db_manager.sort_files_by_date(db_files)
        
        logger.info(f"{Emoji.FILE} –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(db_files)}")
        logger.info(f"{Emoji.SORT} –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ –¥–∞—Ç–µ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è...")
        
        for i, file in enumerate(db_files, 1):
            filename = Path(file).name
            file_date = db_manager.extract_date_from_filename(filename)
            if file_date and file_date != datetime.min:
                logger.info(f"  {i:3}. {filename} - {file_date.strftime('%d.%m.%Y')}")
            else:
                logger.info(f"  {i:3}. {filename} - –¥–∞—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
    
    if not db_files:
        logger.error(f"{Emoji.ERROR} –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!")
        return False
    
    logger.header(f"{Emoji.ROCKET} –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ {Emoji.ROCKET}")
    
    for i, db_file in enumerate(db_files, 1):
        filename = Path(db_file).name
        file_date = db_manager.extract_date_from_filename(filename)
        
        if file_date and file_date != datetime.min:
            logger.info(f"{Emoji.FILE} –§–∞–π–ª {i}/{len(db_files)}: {filename} ({file_date.strftime('%d.%m.%Y')})")
        else:
            logger.info(f"{Emoji.FILE} –§–∞–π–ª {i}/{len(db_files)}: {filename}")
        
        try:
            if i == 1 and db_manager.is_local_db_empty():
                success = db_manager.copy_entire_database(db_file)
            else:
                success = db_manager.process_database(db_file)
            
            if success:
                logger.update_stats('processed_files', 1)
                logger.info(f"{Emoji.SUCCESS} –§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ")
            else:
                logger.warning(f"{Emoji.WARNING} –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞")
            
        except KeyboardInterrupt:
            logger.info(f"\n{Emoji.STOP} ‚ö†  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞.")
            raise
        except Exception as e:
            logger.error(f"{Emoji.ERROR} –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {filename}: {e}")
            import traceback
            logger.error(f"{Emoji.BUG} –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:\n{traceback.format_exc()}")
        
        logger.separator('‚îÄ')
    
    return True


# ============================================================================
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ============================================================================

def main():
    logger = Logger()
    
    try:
        logger.header(f"{Emoji.ROCKET} –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö {Emoji.ROCKET}")
        logger.info(f"{Emoji.GEAR} –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:")
        logger.info(f"  {Emoji.TOGGLE} –û–±—Ä–∞–±–æ—Ç–∫–∞ tech –±–∞–∑: {'üü¢ –í–ö–õ–Æ–ß–ï–ù–û' if CONFIG['PROCESS_TECH_BASES'] else 'üî¥ –í–´–ö–õ–Æ–ß–ï–ù–û'}")
        logger.info(f"  {Emoji.TOGGLE} –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {'üü¢ –í–ö–õ–Æ–ß–ï–ù–û' if CONFIG['HANDLE_DUPLICATE_IDS'] else 'üî¥ –í–´–ö–õ–Æ–ß–ï–ù–û'}")
        logger.info(f"  {Emoji.CLOCK} –¢–∞–π–º–∞—É—Ç SQLite: {CONFIG['SQLITE_TIMEOUT']} —Å–µ–∫")
        logger.info(f"  {Emoji.SETTINGS} –†–µ–∂–∏–º –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è: {CONFIG['SQLITE_JOURNAL_MODE']}")
        logger.info(f"  {Emoji.LOG} –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤: {logger.get_log_path()}")
        
        parser = argparse.ArgumentParser(
            description=f'{Emoji.COMPUTER} –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π',
            formatter_class=argparse.RawDescriptionHelpFormatter,
            epilog=f"""
{Emoji.BULLET} –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  %(prog)s                        # {Emoji.MAN} –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  %(prog)s /–ø—É—Ç—å/–∫/–±–∞–∑–µ.db        # {Emoji.FILE} –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª, –∑–∞—Ç–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  %(prog)s /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ/         # {Emoji.FOLDER} –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–ø–∫—É, –∑–∞—Ç–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  %(prog)s --help                 # {Emoji.QUESTION} –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É

{Emoji.STAR} –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
  {Emoji.CALENDAR} –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
  {Emoji.SORT} –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ –¥–∞—Ç–µ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
  {Emoji.FILE} –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞—Ç –≤ –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤
  {Emoji.MAN} –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—É—Ç–µ–π
  {Emoji.LOCK} –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
            """
        )
        parser.add_argument('target_path', nargs='?', help=f'{Emoji.POINT_RIGHT} –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –ø–∞–ø–∫–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏')
        
        args = parser.parse_args()
        
        logger.info(f"{Emoji.DATABASE} –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        db_manager = DatabaseManager(logger)
        
        if args.target_path:
            logger.info(f"{Emoji.PROCESS} –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏: {args.target_path}")
            try:
                process_path(args.target_path, logger, db_manager)
            except KeyboardInterrupt:
                logger.info(f"{Emoji.STOP} –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
                logger.log_stats()
                logger.header(f"{Emoji.STOP} –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–æ—Å—Ä–æ—á–Ω–æ")
                print(f"\n{Emoji.STOP} ‚ö†  –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–ï–†–í–ê–ù–ê!")
                print(f"{Emoji.DATABASE} üíæ –¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {db_manager.local_db_path}")
                print(f"{Emoji.LOG} üìù –õ–æ–≥ —Ñ–∞–π–ª: {logger.get_log_path()}")
                return
        
        logger.header(f"{Emoji.MAN} –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º {Emoji.WOMAN}")
        logger.info(f"{Emoji.SPEECH} –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏.")
        logger.info(f"{Emoji.KEYBOARD} –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É/–ø–∞–ø–∫–µ –∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞.")
        
        while True:
            try:
                logger.reset_stats()
                
                target_path = ask_for_target_path(logger, is_continue=True)
                
                if target_path is None:
                    logger.info(f"{Emoji.EXIT} –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
                    break
                
                try:
                    process_path(target_path, logger, db_manager)
                except KeyboardInterrupt:
                    logger.info(f"{Emoji.STOP} –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
                    logger.log_stats()
                    continue
                
                db_manager.show_statistics()
                logger.log_stats()
                
                logger.header(f"{Emoji.CHECK} –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ {Emoji.PARTY}")
                logger.info(f"{Emoji.DATABASE} –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {db_manager.local_db_path}")
                logger.info(f"{Emoji.LOG} –õ–æ–≥ —Ñ–∞–π–ª: {logger.get_log_path()}")
                
                print(f"\n{Emoji.CONFETTI} {Colors.GREEN}{Colors.BOLD}‚úÖ –°–ï–°–°–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–í–ï–†–®–ï–ù–ê!{Colors.RESET}")
                print(f"{Emoji.FILE} üìÅ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤ –≤ —Å–µ—Å—Å–∏–∏: {logger.stats['processed_files']}")
                print(f"{Emoji.DATABASE} üíæ –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞: {db_manager.local_db_path}")
                print(f"{Emoji.LOG} üìù –õ–æ–≥ —Ñ–∞–π–ª: {logger.get_log_path()}")
                
            except KeyboardInterrupt:
                logger.info(f"\n{Emoji.STOP} ‚ö†  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
                break
            except Exception as e:
                logger.error(f"{Emoji.ERROR} –ù–ï–û–ñ–ò–î–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: {e}")
                import traceback
                error_details = traceback.format_exc()
                logger.error(f"{Emoji.BUG} –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:\n{error_details}")
                logger.info(f"{Emoji.RETRY} –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ...")
        
        logger.header(f"{Emoji.FLAG} –†–∞–±–æ—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞ {Emoji.FLAG}")
        logger.info(f"{Emoji.DATABASE} –ò—Ç–æ–≥–æ–≤–∞—è –±–∞–∑–∞: {db_manager.local_db_path}")
        logger.info(f"{Emoji.LOG} –õ–æ–≥ —Ñ–∞–π–ª: {logger.get_log_path()}")
        
        print(f"\n{Emoji.FLAG} {Colors.CYAN}{Colors.BOLD}üèÅ –†–ê–ë–û–¢–ê –ü–†–û–ì–†–ê–ú–ú–´ –ó–ê–í–ï–†–®–ï–ù–ê!{Colors.RESET}")
        print(f"{Emoji.DATABASE} üíæ –ò—Ç–æ–≥–æ–≤–∞—è –±–∞–∑–∞: {db_manager.local_db_path}")
        print(f"{Emoji.LOG} üìù –õ–æ–≥ —Ñ–∞–π–ª: {logger.get_log_path()}")
        
    except KeyboardInterrupt:
        logger.info(f"\n\n{Emoji.STOP} ‚ö†  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
        sys.exit(0)
    except FileNotFoundError as e:
        logger.error(f"{Emoji.ERROR} –û–®–ò–ë–ö–ê: {e}")
        sys.exit(1)
    except Exception as e:
        logger.error(f"{Emoji.ERROR} –ù–ï–û–ñ–ò–î–ê–ù–ù–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        error_details = traceback.format_exc()
        logger.error(f"{Emoji.BUG} –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:\n{error_details}")
        sys.exit(1)


if __name__ == "__main__":
    main()
